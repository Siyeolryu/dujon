# 백엔드 개발 업무 단계별 계획

**작성일**: 2026년 1월 30일  
**대상**: Phase 2 - 2단계 REST API 서버 (Flask + Google Sheets)  
**현재 상태**: 2-1 조회 API 구조 및 구현 완료, 2-2 수정 API 미구현

---

## 📋 전체 단계 요약

| 단계 | 내용 | 예상 소요 | 상태 |
|------|------|-----------|------|
| **0** | 환경 점검 및 의존성 정리 | 0.5일 | ✅ 대부분 완료 |
| **1** | 조회 API 검증 및 보완 | 0.5일 | 🔄 점검 필요 |
| **2** | Sheets 서비스 쓰기 기능 확장 | 1일 | ⏳ 예정 |
| **3** | 데이터 수정 API (POST/PUT) | 1~1.5일 | ⏳ 예정 |
| **4** | 소장 배정/배정해제 API | 1일 | ⏳ 예정 |
| **5** | 검증·에러 처리·테스트 | 0.5~1일 | ⏳ 예정 |
| **6** | (선택) 실시간 동기화·캐싱 | 1일 | ⏳ 선택 |

---

## 0단계: 환경 점검 및 의존성 정리

**목표**: API 서버 실행 환경과 Google Sheets 연동이 안정적으로 동작하는지 확인

### 할 일

- [ ] **0-1** `requirements_api.txt` 확인 및 패키지 설치
  - `flask`, `flask-cors`, `python-dotenv`, `google-auth`, `google-auth-oauthlib`, `google-api-python-client`
- [ ] **0-2** `.env` 설정 확인
  - `SPREADSHEET_ID`, `FLASK_PORT`, `FLASK_DEBUG`, `ALLOWED_ORIGINS` (필요 시)
- [ ] **0-3** Google 인증 파일 확인
  - 프로젝트 루트에 `client_secret_xxx.json` 또는 `credentials.json` 존재
  - 최초 실행 후 `token.pickle` 생성 여부
- [ ] **0-4** 서버 기동 및 헬스 체크
  - `python run_api.py` 또는 `python api/app.py` 실행
  - `GET http://localhost:5000/api/health` 응답 확인

**참고 문서**: `Phase2_2단계_개요.md` – 빠른 시작

---

## 1단계: 조회 API 검증 및 보완

**목표**: 기존 GET 엔드포인트가 스펙·가이드와 일치하는지 검증하고, 누락된 동작 보완

### 할 일

- [ ] **1-1** 현장 API 검증
  - `GET /api/sites` – 목록, 쿼리 `company`, `status`, `state` 동작 확인
  - `GET /api/sites/search?q=검색어` – 검색 동작 확인
  - `GET /api/sites/<id>` – 상세 조회, 없을 때 404 응답 확인
- [ ] **1-2** 인력/자격증 API 검증
  - `GET /api/personnel`, `GET /api/personnel/<id>` 응답 형식 확인
  - `GET /api/certificates`, `GET /api/certificates/<id>` 응답 형식 확인
- [ ] **1-3** 통계 API 검증
  - `GET /api/stats` – 미배정 현장 수, 투입가능 인력 수 등 요구사항 반영 여부 확인
- [ ] **1-4** 응답 형식 통일
  - 성공 시 `success: true`, `data`, `timestamp` 등 가이드와 동일한지 확인
  - 에러 시 `success: false`, `error.code`, `error.message` 형식 확인

**참고 문서**: `2-1_데이터조회API_가이드.md`

---

## 2단계: Sheets 서비스 쓰기 기능 확장

**목표**: Google Sheets에 데이터를 쓰기 위한 메서드를 `sheets_service`에 추가

### 할 일

- [ ] **2-1** 단일 셀/행 업데이트
  - `update_cell(range_name, value)` – 셀 1개 업데이트
  - `update_row(range_name, values)` – 한 행 업데이트, `valueInputOption='USER_ENTERED'`
- [ ] **2-2** 일괄 업데이트
  - `batch_update(updates)` – 여러 범위를 한 번에 업데이트 (`batchUpdate` 사용)
- [ ] **2-3** 행 탐색·추가
  - `find_row_by_id(sheet_name, id_value)` – ID 컬럼(A열) 기준으로 행 번호 반환 (2행부터)
  - `append_row(sheet_name, values)` – 시트 마지막에 행 추가
- [ ] **2-4** 시트 이름·컬럼 상수 정리
  - 시트1(현장), 시트2(인력), 시트3(자격증) 이름 및 주요 컬럼 인덱스를 상수/주석으로 정리 (유지보수용)

**참고 문서**: `2-2_데이터수정API_가이드.md` – 1단계 Sheets 서비스 확장

---

## 3단계: 데이터 수정 API (POST/PUT)

**목표**: 현장/인력/자격증 생성·수정 엔드포인트 구현

### 할 일

- [ ] **3-1** 현장 생성
  - `POST /api/sites` – Body: 현장ID, 현장명, 회사구분, 주소 등 필수 필드
  - 필수 필드 검증 후 `append_row`로 시트1에 추가
  - 응답: 생성된 현장 정보 (201)
- [ ] **3-2** 현장 수정
  - `PUT /api/sites/<id>` – Body: 수정할 필드만 전달 가능
  - `find_row_by_id`로 행 찾은 뒤 `update_row` 또는 `batch_update`로 반영
  - 없으면 404
- [ ] **3-3** 인력 수정
  - `PUT /api/personnel/<id>` – 시트2 해당 행 업데이트
  - 필드 검증 (직책, 현재상태 등 드롭다운 값)
- [ ] **3-4** 자격증 수정
  - `PUT /api/certificates/<id>` – 시트3 해당 행 업데이트
  - 사용가능여부, 현재사용현장ID 등 일관성 유지

**참고 문서**: `2-2_데이터수정API_가이드.md` – 2단계 현장 수정 라우트

---

## 4단계: 소장 배정/배정해제 API

**목표**: 현장에 소장·자격증을 배정/해제하는 비즈니스 로직 구현

### 할 일

- [ ] **4-1** 소장 배정
  - `POST /api/sites/<id>/assign`
  - Body: `담당소장ID`, (선택) `사용자격증ID`
  - 검증: 현장 존재, 인력 존재, 해당 인력이 투입가능 상태인지
  - 시트1 해당 행: 담당소장ID, 사용자격증ID, 배정상태=배정완료, 수정일 갱신
  - 시트2 해당 인력: 현재상태=투입중, 현재담당현장수 증가 (또는 로직에 맞게)
  - 시트3 해당 자격증: 사용가능여부=사용중, 현재사용현장ID=현장ID
- [ ] **4-2** 소장 배정 해제
  - `POST /api/sites/<id>/unassign`
  - 시트1: 담당소장ID/사용자격증ID 초기화, 배정상태=미배정
  - 시트2: 해당 인력 상태/담당현장수 복원
  - 시트3: 해당 자격증 사용가능여부/현재사용현장ID 초기화
- [ ] **4-3** 트랜잭션·일관성
  - 배정/해제 시 시트1·2·3를 순서대로 업데이트하고, 중간 실패 시 되돌리기 또는 에러 메시지 명확히 반환

**참고 문서**: `2-2_데이터수정API_가이드.md` – 소장 배정 로직, `DB_구조_설계.md`

---

## 5단계: 검증·에러 처리·테스트

**목표**: 입력 검증, 에러 메시지 통일, 기본 동작 테스트

### 할 일

- [ ] **5-1** 입력 검증
  - 현장: 회사구분, 현장상태, 배정상태 등 드롭다운 값 허용 목록 검증
  - 인력: 직책, 현재상태 등
  - 자격증: 사용가능여부 등
  - 날짜 필드 형식 (YYYY-MM-DD)
- [ ] **5-2** 에러 응답 통일
  - 400: 잘못된 요청 (필수 필드 누락, 잘못된 값)
  - 404: 리소스 없음
  - 409: 비즈니스 규칙 위반 (예: 이미 배정된 자격증)
  - 500: 서버/Sheets API 오류 – 로깅 후 일반화된 메시지 반환
- [ ] **5-3** 간단 테스트
  - curl 또는 Postman으로 주요 엔드포인트 호출 (GET 전부, POST/PUT/assign/unassign 각 1회 이상)
  - (선택) pytest 등으로 `/api/health`, `/api/sites` 등 기본 라우트 자동 테스트

**참고 문서**: `2-1_데이터조회API_가이드.md`, `2-2_데이터수정API_가이드.md` – 에러 핸들러 예시

---

## 6단계 (선택): 실시간 동기화·캐싱

**목표**: API 할당량 절감 및 다중 사용자 환경 대비

### 할 일

- [ ] **6-1** 읽기 캐싱
  - 단순 메모리 캐시(예: TTL 30초~1분)로 `get_all_sites`, `get_all_personnel`, `get_all_certificates` 결과 캐싱
  - 수정 API 호출 시 해당 리소스 캐시 무효화
- [ ] **6-2** (선택) 버전/낙관적 잠금
  - 시트에 "버전" 또는 "수정일시" 컬럼 활용
  - PUT 시 클라이언트가 보낸 버전과 현재 값이 다르면 409 반환
- [ ] **6-3** (선택) 변경 이력
  - 배정/배정해제 이력을 별도 시트나 로그에 기록 (요구사항 있을 경우)

**참고 문서**: `Phase2_2단계_개요.md` – 2-3 실시간 동기화, (있을 경우) `2-3_실시간동기화_가이드.md`

---

## 📅 권장 일정 (예시)

| 주차 | 단계 | 산출물 |
|------|------|--------|
| 1주 | 0, 1 | 환경 정리, 조회 API 검증 완료 |
| 1주 | 2 | Sheets 쓰기 메서드 추가 완료 |
| 2주 | 3, 4 | POST/PUT/assign/unassign API 구현 완료 |
| 2주 | 5 | 검증·에러·테스트 정리 |
| 3주 | 6 (선택) | 캐싱 또는 동기화 적용 |

---

## 📁 참고 파일

| 파일 | 용도 |
|------|------|
| `api/app.py` | Flask 앱 진입점 |
| `api/routes/sites.py` | 현장 조회·수정·배정 라우트 |
| `api/routes/personnel.py` | 인력 조회·수정 |
| `api/routes/certificates.py` | 자격증 조회·수정 |
| `api/routes/stats.py` | 통계 |
| `api/services/sheets_service.py` | Google Sheets 읽기/쓰기 |
| `2-1_데이터조회API_가이드.md` | 조회 API 스펙·예제 |
| `2-2_데이터수정API_가이드.md` | 수정 API 스펙·예제 |
| `Phase2_2단계_개요.md` | 2단계 전체 개요 |
| `DB_구조_설계.md` | 시트/컬럼 구조 |

---

*이 계획은 프로젝트 진행에 따라 단계를 추가·수정할 수 있습니다.*

# ê°œë°œì¼ì§€ 2026-02-03 - ê°œë°œ ëª…ì„¸ì„œ

**ì‘ì„±ì¼**: 2026ë…„ 2ì›” 3ì¼  
**ì‘ì„±ì**: ê°œë°œíŒ€  
**êµ¬ë¶„**: Supabase DB ì •ê·œí™” ë° í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ ì—°ê²°

---

## ğŸ“Œ ì˜¤ëŠ˜ ìš”ì•½

- **Supabase DB ì •ê·œí™” (v2)** ì™„ë£Œ â€” ENUM íƒ€ì…, ì°¸ì¡°/ê´€ê³„ í…Œì´ë¸”, RLS ì •ì±…
- **í”„ë¡ íŠ¸ì—”ë“œ Supabase ì§ì ‘ ì—°ê²°** â€” Flask API ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ Supabase ì§ì ‘ í˜¸ì¶œ
- **ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸** â€” Google Sheets CSV â†’ Supabase ì´ê´€ SQL/Python ì½”ë“œ
- **API ëª¨ë“œ ì „í™˜** â€” `config.js`ì—ì„œ `API_MODE: 'supabase'` ê¸°ë³¸ ì„¤ì •

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. Supabase DB ì •ê·œí™”ëœ ìŠ¤í‚¤ë§ˆ (v2)

| í•­ëª© | ë‚´ìš© | íŒŒì¼ |
|------|------|------|
| ENUM íƒ€ì… ì •ì˜ | `personnel_status`, `certificate_status`, `site_status`, `assignment_status`, `assignment_role`, `assignment_active_status` | `002_normalized_schema.sql` |
| ì°¸ì¡° í…Œì´ë¸” | `companies`, `certificate_types` | `002_normalized_schema.sql` |
| ì£¼ìš” í…Œì´ë¸” | `personnel`, `certificates`, `sites` (UUID PK, FK ê´€ê³„, `legacy_id` í˜¸í™˜) | `002_normalized_schema.sql` |
| ë°°ì • ê´€ê³„ í…Œì´ë¸” | `site_assignments`, `certificate_assignments` (N:M ê´€ê³„) | `002_normalized_schema.sql` |
| ì¸ë±ìŠ¤ | íšŒì‚¬/ìƒíƒœ/legacy_id ë“± ì¡°íšŒ ìµœì í™” ì¸ë±ìŠ¤ | `002_normalized_schema.sql` |
| RLS ì •ì±… | ëª¨ë“  í…Œì´ë¸”ì— Row Level Security í™œì„±í™” ë° ê³µê°œ ì •ì±… | `002_normalized_schema.sql` |

**íŠ¹ì§•**:
- UUID ê¸°ë°˜ Primary Keyë¡œ í™•ì¥ì„± í™•ë³´
- `legacy_id` í•„ë“œë¡œ ê¸°ì¡´ Google Sheets IDì™€ í˜¸í™˜
- N:M ê´€ê³„ í…Œì´ë¸”(`site_assignments`, `certificate_assignments`)ë¡œ ë°°ì • ì´ë ¥ ê´€ë¦¬ ê°€ëŠ¥
- ENUM íƒ€ì…ìœ¼ë¡œ ìƒíƒœê°’ ì¼ê´€ì„± ë³´ì¥

### 2. í”„ë¡ íŠ¸ì—”ë“œ Supabase ì§ì ‘ ì—°ê²°

| í•­ëª© | ë‚´ìš© | íŒŒì¼ |
|------|------|------|
| Supabase API ëª¨ë“ˆ | `SupabaseAPI` ê°ì²´ â€” getSites, searchSites, getSiteDetail, createSite, updateSite, assignManager, unassignManager, getPersonnel, getCertificates, getStats | `js/supabase-api.js` |
| ë°ì´í„° ë³€í™˜ | ì •ê·œí™”ëœ DB ì‘ë‹µ â†’ ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ í˜•ì‹(`í˜„ì¥ID`, `í˜„ì¥ëª…` ë“± í•œê¸€ í‚¤) | `js/supabase-api.js` |
| JOIN ì¿¼ë¦¬ | `select`ì—ì„œ íšŒì‚¬ëª…, ë°°ì • ì¸ë ¥/ìê²©ì¦ ì •ë³´ JOIN | `js/supabase-api.js` |
| ì—ëŸ¬ ì²˜ë¦¬ | UI.showToast()ë¡œ ì‚¬ìš©ì ì•Œë¦¼ | `js/supabase-api.js` |

**ì£¼ìš” ê¸°ëŠ¥**:
```javascript
// í˜„ì¥ ëª©ë¡ (íšŒì‚¬, ë°°ì •ìƒíƒœ, í˜„ì¥ìƒíƒœ í•„í„°)
SupabaseAPI.getSites({ company: 'ë”ì¡´ì¢…í•©ê±´ì„¤', status: 'ë¯¸ë°°ì •' })

// í˜„ì¥ ê²€ìƒ‰ (ì´ë¦„, ì£¼ì†Œ, ê±´ì¶•ì£¼ëª…)
SupabaseAPI.searchSites('ì„œìš¸')

// ì†Œì¥ ë°°ì •
SupabaseAPI.assignManager(siteId, { manager_id, certificate_id })

// ë°°ì • í•´ì œ
SupabaseAPI.unassignManager(siteId)
```

### 3. ë°±ì—”ë“œ Supabase ì„œë¹„ìŠ¤ í†µí•©

| í•­ëª© | ë‚´ìš© | íŒŒì¼ |
|------|------|------|
| SupabaseService | SheetsServiceì™€ ë™ì¼ ì¸í„°í˜ì´ìŠ¤, Supabase ë°±ì—”ë“œ | `api/services/supabase_service.py` |
| ì½ê¸° ë©”ì„œë“œ | `get_all_sites`, `get_site_by_id`, `get_all_personnel`, `get_all_certificates` | `api/services/supabase_service.py` |
| ì“°ê¸° ë©”ì„œë“œ | `create_site`, `update_site`, `assign_site`, `unassign_site` | `api/services/supabase_service.py` |
| ë°ì´í„° ë³€í™˜ | DB í–‰ â†’ API ë”•ì…”ë„ˆë¦¬ (í•œê¸€ í‚¤ í˜¸í™˜) | `api/services/supabase_service.py` |

### 4. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

| í•­ëª© | ë‚´ìš© | íŒŒì¼ |
|------|------|------|
| SQL ë§ˆì´ê·¸ë ˆì´ì…˜ | temp í…Œì´ë¸” â†’ personnel/certificates/sites INSERT, ë°°ì • ê´€ê³„ ìƒì„± | `js/data_migration.sql` |
| Python ì°¸ê³  ì½”ë“œ | pandas + supabase-py ì˜ˆì‹œ | `js/data_migration.sql` (ì£¼ì„) |
| ê²€ì¦ ì¿¼ë¦¬ | ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ë°ì´í„° ê°œìˆ˜/ë°°ì • í˜„í™© í™•ì¸ | `js/data_migration.sql` |

### 5. ì„¤ì • ë³€ê²½

| í•­ëª© | ë³€ê²½ ë‚´ìš© | íŒŒì¼ |
|------|----------|------|
| API ëª¨ë“œ | `API_MODE: 'supabase'` (ê¸°ë³¸ê°’) | `js/config.js` |
| Supabase URL/Key | í”„ë¡œì íŠ¸ URL ë° anon key ì„¤ì • | `js/config.js` |
| Flask ë°±ì—”ë“œ URL | `API_MODE: 'flask'`ì¼ ë•Œë§Œ ì‚¬ìš© | `js/config.js` |

---

## ğŸ“Š ì•„í‚¤í…ì²˜ ë³€ê²½

### Before (Phase 2ê¹Œì§€)
```
Google Sheets â†â†’ Flask API â†â†’ HTML/JS ì•±
```

### After (Supabase ì •ê·œí™”)
```
[ ì˜µì…˜ A: Supabase ì§ì ‘ ì—°ê²° (ê¶Œì¥) ]
Supabase DB â†â†’ HTML/JS ì•± (supabase-api.js)

[ ì˜µì…˜ B: Flask ë°±ì—”ë“œ ìœ ì§€ ]
Supabase DB â†â†’ Flask API (supabase_service.py) â†â†’ HTML/JS ì•±
```

---

## ğŸ“ ìƒˆë¡œ ì¶”ê°€/ìˆ˜ì •ëœ íŒŒì¼

| íŒŒì¼ | êµ¬ë¶„ | ì„¤ëª… |
|------|------|------|
| `supabase/migrations/002_normalized_schema.sql` | ì‹ ê·œ | ì •ê·œí™”ëœ DB ìŠ¤í‚¤ë§ˆ (v2) |
| `js/supabase-api.js` | ì‹ ê·œ | í”„ë¡ íŠ¸ì—”ë“œ Supabase ì§ì ‘ ì—°ê²° ëª¨ë“ˆ |
| `js/data_migration.sql` | ì‹ ê·œ | Google Sheets â†’ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ |
| `api/services/supabase_service.py` | ì‹ ê·œ | ë°±ì—”ë“œ Supabase ì„œë¹„ìŠ¤ |
| `js/config.js` | ìˆ˜ì • | API_MODE ë° Supabase ì„¤ì • ì¶”ê°€ |

---

## ğŸ”§ DB í…Œì´ë¸” êµ¬ì¡° ìš”ì•½

### ì°¸ì¡° í…Œì´ë¸”
| í…Œì´ë¸” | í•„ë“œ | ì„¤ëª… |
|--------|------|------|
| `companies` | id (UUID), name, short_name | íšŒì‚¬ (ë”ì¡´ì¢…í•©ê±´ì„¤, ë”ì¡´í•˜ìš°ì§•) |
| `certificate_types` | id (UUID), name, description | ìê²©ì¦ ì¢…ë¥˜ (ê±´ì¶•ê¸°ì‚¬, ê±´ì„¤ì´ˆê¸‰ ë“±) |

### ì£¼ìš” í…Œì´ë¸”
| í…Œì´ë¸” | ì£¼ìš” í•„ë“œ | ì„¤ëª… |
|--------|----------|------|
| `personnel` | id, legacy_id, company_id(FK), name, phone, status | ì¸ë ¥í’€ |
| `certificates` | id, legacy_id, personnel_id(FK), cert_type_id(FK), status | ìê²©ì¦í’€ |
| `sites` | id, legacy_id, company_id(FK), name, address, status, assignment_status | í˜„ì¥ì •ë³´ |

### ë°°ì • ê´€ê³„ í…Œì´ë¸” (N:M)
| í…Œì´ë¸” | ê´€ê³„ | ì„¤ëª… |
|--------|------|------|
| `site_assignments` | sites â†” personnel | í˜„ì¥-ì†Œì¥ ë°°ì • (ì—­í• , ìƒíƒœ, ë°°ì •/í•´ì œì¼) |
| `certificate_assignments` | certificates â†” sites | ìê²©ì¦-í˜„ì¥ ë°°ì • |

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ë‹¤ìŒ ë‹¨ê³„

### ì£¼ì˜ì‚¬í•­
1. **API ëª¨ë“œ ì „í™˜**: `js/config.js`ì˜ `API_MODE`ë¡œ 'supabase' / 'flask' ì„ íƒ
2. **legacy_id í˜¸í™˜**: ê¸°ì¡´ ì‹œíŠ¸ID(S001, P001, C001 ë“±)ëŠ” `legacy_id` í•„ë“œë¡œ ë³´ì¡´
3. **RLS ì •ì±…**: í˜„ì¬ëŠ” ëª¨ë“  ì ‘ê·¼ í—ˆìš© (`USING (true)`) â€” ìš´ì˜ ì‹œ ê¶Œí•œ ì œí•œ í•„ìš”
4. **ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ**: `002_normalized_schema.sql` ì‹¤í–‰ â†’ `data_migration.sql` ì‹¤í–‰

### ì„ íƒ ì§„í–‰ ê°€ëŠ¥ í•­ëª©
- [ ] **ì‹¤ì œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**: CSV íŒŒì¼ â†’ Supabase ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] **RLS ì •ì±… ê°•í™”**: ì‚¬ìš©ìë³„ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
- [ ] **ê¸°ì¡´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**: í˜„ì¥ ëª©ë¡, ë°°ì •/í•´ì œ UI ë™ì‘ í™•ì¸
- [ ] **Streamlit ì•± ì—°ë™**: Supabase ì„œë¹„ìŠ¤ ì‚¬ìš© ì „í™˜

---

## ğŸ“‹ Git ì»¤ë°‹ ë‚´ì—­ (ê´€ë ¨)

| ì»¤ë°‹ | ë‚´ìš© |
|------|------|
| `7158abe` | feat: Supabase DB normalization and frontend direct connection |
| `9b34d8e` | Supabase DB ì—°ë™: Google Sheets â†’ Supabase ì‚¬ìš©, db_service í†µí•©, ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ê°€ì´ë“œ ì¶”ê°€ |

---

## ğŸ“ ì°¸ì¡° ë¬¸ì„œ

- `supabase/migrations/002_normalized_schema.sql` â€” ì •ê·œí™”ëœ DB ìŠ¤í‚¤ë§ˆ
- `js/supabase-api.js` â€” í”„ë¡ íŠ¸ì—”ë“œ Supabase API ëª¨ë“ˆ
- `api/services/supabase_service.py` â€” ë°±ì—”ë“œ Supabase ì„œë¹„ìŠ¤
- `js/data_migration.sql` â€” ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
- `docs/Supabase_SQL_ë°_Table_Editor_ê°€ì´ë“œ.md` â€” Supabase ì‚¬ìš© ê°€ì´ë“œ
- `ê°œë°œëª…ì„¸ì„œ_ì „ì²´_GeminiíšŒì˜ìš©.md` â€” ì „ì²´ ê°œë°œ ëª…ì„¸

---

**ë‹¤ìŒ ê°œë°œì¼ì§€**: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ ë˜ëŠ” ì¶”ê°€ ê¸°ëŠ¥ ê°œë°œ ì‹œ

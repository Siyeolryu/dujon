# 현장배정 관리 시스템 — 개발 진행 전체 보고서

**보고 대상**: 본사 상사·임원  
**작성일**: 2026년 2월 4일  
**프로젝트명**: 현장배정 관리 시스템 (dujon)

---

## 1. 요약 (Executive Summary)

현장·인력·자격증을 관리하고 소장 배정을 지원하는 **현장배정 관리 시스템**의 Phase 1·Phase 2 개발이 단계별로 진행되었으며, **핵심 기능(데이터 조회/수정, 소장 배정, 웹 UI)은 구현 완료**된 상태입니다.

- **Phase 1**: Google Sheets 기반 DB 구축 및 데이터 업로드 완료(1,182셀, 100% 성공).
- **Phase 2**:  
  - Google Sheets 고급 기능(검증·조건부 서식·VLOOKUP) 적용 완료.  
  - **REST API**(조회/수정/배정·해제) 및 **낙관적 잠금** 구현 완료.  
  - **HTML/JS 관리 화면**과 **Streamlit 웹 앱**에서 API 연동 및 소장 배정 UI 제공.  
  - **Supabase DB 정규화(v2)** 및 프론트엔드·백엔드 연동 개선 완료.

실시간 푸시(SSE/WebSocket), API 인증 강화, UI/UX 개선 등은 향후 단계에서 진행 예정입니다.

---

## 2. 프로젝트 목표 및 배경

### 2.1 목적

- **현장 정보**, **인력풀**, **자격증풀**을 한 곳에서 관리.
- **소장 배정/해제**를 앱에서 수행해 배정 시간 단축 및 오류 감소.
- 본사·현장에서 **실시간에 가까운 데이터 조회·수정** 가능하도록 연동.

### 2.2 목표 시스템 구조

| 구분 | 내용 |
|------|------|
| 데이터 저장 | Google Sheets(기존) 또는 Supabase(정규화 DB) |
| 연동 계층 | REST API (Flask) 또는 프론트엔드-Supabase 직접 연동 |
| 사용자 화면 | HTML/JS 관리 화면, Streamlit 웹 앱(대시보드·현장 목록·등록·투입가능 인원 등) |

---

## 3. Phase 1 성과 (참고)

- Google Sheets API 연동 완료.
- 3개 시트(현장정보, 인력풀, 자격증풀) 기준 **1,182개 셀 데이터 업로드**, 100% 성공.
- Phase 2의 기반 DB·시트 구조 확보.

---

## 4. Phase 2 개발 완료 현황

### 4.1 1단계: Google Sheets 고급 기능 ✅ 완료

| 항목 | 내용 | 상태 |
|------|------|------|
| 1-1 데이터 검증 | 회사구분·현장상태·배정상태·직책·현재상태·사용가능여부 등 드롭다운, 날짜/전화번호/이메일 검증 (18개 규칙) | ✅ 완료 |
| 1-2 조건부 서식 | 배정상태·현장상태·인력·자격증 상태별 색상, 헤더·줄무늬 등 24개 서식 | ✅ 완료 |
| 1-3 VLOOKUP 수식 | 담당소장명·연락처, 자격증명·소유자명·연락처 등 5개 컬럼 자동 조회 (IFERROR 포함) | ✅ 완료 |

**효과**: 입력 오류 감소, 시각적 구분 용이, 관련 데이터 자동 표시로 조회 시간 단축.

---

### 4.2 2단계: 실시간 데이터 연동 API ✅ 완료

| 항목 | 내용 | 상태 |
|------|------|------|
| 2-1 데이터 조회 API | GET /api/sites, /sites/<id>, /personnel, /certificates, /stats (필터: 회사·배정상태·현장상태) | ✅ 완료 |
| 2-2 데이터 수정 API | POST /api/sites(현장 생성), PUT /api/sites/<id>(수정), POST 배정/해제, PUT 인력·자격증 수정 | ✅ 완료 |
| 2-3 실시간 동기화 | 낙관적 잠금(버전·수정일 기반), If-Match/body.version, 충돌 시 409 Conflict 반환 | ✅ 완료 |

**구현 파일**: `api/app.py`, `api/routes/`(sites, personnel, certificates, stats), `api/services/`(sheets_service, supabase_service, validation, sync_manager).

**데이터 소스**: Google Sheets(SheetsService) 또는 Supabase(SupabaseService) 중 환경 설정에 따라 선택 가능.

---

### 4.3 3단계: HTML 앱·Streamlit 기능 확장 ✅ 핵심 완료

| 항목 | 내용 | 상태 |
|------|------|------|
| 3-1 API 연동 | app.js·api.js에서 API 호출로 현장/인력/자격증/통계 로드 | ✅ 완료 |
| 3-2 소장 배정 UI | 배정 패널, 투입가능 소장·자격증 선택, 배정/해제, 버전 전달·409 처리 | ✅ 완료 |
| 3-3 실시간 푸시 | SSE/WebSocket | ❌ 미구현 (선택 사항) |

**Streamlit 앱**:  
- 메인: `streamlit_app.py` (페이지: 대시보드, 현장 목록, 현장등록, 자격증등록, 투입가능인원 상세).  
- API 연결 확인, 환경별 API URL 설정, HTML/JS 통합(인라인) 지원.  
- Streamlit Cloud 배포 가이드 및 환경 감지·API URL 자동 설정 완료.

---

## 5. DB·인프라: Supabase 정규화 및 연동

### 5.1 Supabase 정규화 스키마(v2)

- **참조 테이블**: companies, certificate_types  
- **주요 테이블**: sites, personnel, certificates (UUID PK, legacy_id로 기존 ID 호환)  
- **관계 테이블**: site_assignments(현장–소장), certificate_assignments(자격증–현장)  
- **ENUM·인덱스·RLS** 적용으로 확장성·일관성 확보.

### 5.2 연동 방식

| 방식 | 설명 | 용도 |
|------|------|------|
| Supabase 직접 연결 | 프론트엔드(js/supabase-api.js)에서 Supabase 클라이언트로 조회·배정·해제 | API 없이 브라우저에서 직접 DB 사용 |
| Flask + Supabase | api/services/supabase_service.py로 동일 스키마 지원 | 기존 API 경로 유지 시 |

- **config.js**에서 `API_MODE: 'supabase'` 또는 `'flask'` 선택 가능.
- 백엔드 Supabase 서비스는 정규화 스키마(v2)에 맞춰 JOIN·배정 로직 정리 완료(DB–Logic–Frontend 연결 개선 완료).

### 5.3 데이터 마이그레이션

- Google Sheets → Supabase 이관용 SQL·참고 스크립트 제공(js/data_migration.sql 등).
- 실제 대량 이관은 환경 구축 후 실행 예정.

---

## 6. 품질·점검 결과

### 6.1 Red Team UI/UX 점검 (2026-02-04)

- **치명적 이슈**: 상단 네비게이션 URL이 실제 Streamlit 경로와 일치하는지 검증 필요(404 방지).  
- **개선 권장**: 배정 패널 위치·테이블 표시 방식(st.dataframe 등)·날짜 필드 검증·현재 페이지 강조·메트릭 카드 클릭 연동·반응형·접근성 등.  
- 상세: `docs/RedTeam_UI_UX_점검_보고서.md` 참조.

### 6.2 DEBUG 명세서 반영 (1↔2↔3↔4단계)

- 시트 컬럼 수 분기(17/22컬럼), SPREADSHEET_ID 환경변수화, API 요청 ID·로깅, 필터·version·409 처리, API 실패 vs 0건 구분 등 반영 완료.

### 6.3 보안·운영 (Red Team 제안)

- API 키(또는 토큰) 검증: 배포 시 도입 권장.  
- CORS·민감 정보: 배포 도메인 명시, .env 사용 권장.  
- 409 시 사용자 안내·재시도/새로고침 유도 권장.

---

## 7. 현재 제공 기능 요약

| 구분 | 기능 | 비고 |
|------|------|------|
| 데이터 | 현장·인력·자격증 조회/수정, 통계 | API 및 Supabase 직접 연동 |
| 배정 | 소장 배정·해제, 버전(낙관적 잠금) | 409 시 재시도 안내 권장 |
| 화면 | HTML 관리 화면(site-management.html) | 필터·검색·배정 패널 |
| 화면 | Streamlit(대시보드, 현장 목록·등록, 자격증등록, 투입가능인원 상세) | 로컬·Streamlit Cloud |
| DB | Google Sheets 3시트 또는 Supabase 정규화(v2) | 설정으로 전환 가능 |

---

## 8. 미완료·선택 사항 및 권장

| 구분 | 항목 | 비고 |
|------|------|------|
| 기능 | 실시간 푸시(SSE/WebSocket) | 선택 사항 |
| 보안 | API 키/토큰 검증 | 배포 전 권장 |
| UI/UX | 네비 URL 검증, 배정 패널 위치, 테이블·날짜 검증, 메트릭 클릭 연동 | Red Team 보고서 기준 |
| 운영 | 실제 데이터 마이그레이션(Sheets→Supabase) | 필요 시 실행 |
| 테스트 | 3단계 E2E·통합 테스트 강화 | 선택 |

---

## 9. 일정·다음 단계

- **완료**: Phase 2의 1단계(Sheets 고급화), 2단계(API·낙관적 잠금), 3단계(API 연동·배정 UI), Supabase 정규화 및 연동 개선, Streamlit 배포 개선.  
- **권장 순서**:  
  1) 상단 네비 URL 및 배정 패널 등 UI 개선 적용  
  2) 배포 환경에서 API 인증·CORS 정리  
  3) 필요 시 실시간 푸시·E2E 테스트 검토  

---

## 10. 결론

- **현장배정 관리 시스템**의 Phase 1·Phase 2 핵심 개발은 완료되었고, **데이터 조회/수정, 소장 배정, 웹(HTML·Streamlit) 화면**이 동작 가능한 상태입니다.  
- **Supabase 정규화(v2)**와 프론트엔드·백엔드 연동 개선으로 확장성과 일관성이 확보되었습니다.  
- Red Team 점검·DEBUG 반영으로 **품질·연동 이슈**가 정리되었으며, **배포 전 보안 강화** 및 **UI/UX 개선**을 단계적으로 진행하시면 됩니다.

---

**문서 버전**: 1.0  
**관련 문서**: Phase2_착수보고서.md, Phase2_단계별_개발계획.md, 개발일지(2026-01-30·02-02·02-03), RedTeam_UI_UX_점검_보고서.md, DB_Logic_Frontend_연결_점검_보고서.md, 개선_완료_요약.md, Streamlit_배포_개선_완료.md

# 1~3단계 진행상황 및 Red Team 제안

**작성일**: 2026-02-02  
**목적**: Phase 2 개발 1~3단계 진행상황 점검 + Red Team 관점 부족/위험 요소 제안

---

## 1. 1~3단계 진행상황 요약

### 1단계: Google Sheets 고급 기능 (1-2일)

| 항목 | 계획 | 구현 상태 | 비고 |
|------|------|-----------|------|
| **1-1 데이터 검증** | `apply_data_validation.py` | ✅ 구현됨 | 드롭다운(회사구분/현장상태/배정상태, 직책/현재상태, 사용가능여부), 날짜/전화번호/이메일 검증 |
| **1-2 조건부 서식** | `apply_conditional_formatting.py` | ✅ 구현됨 | 배정상태/현장상태/인력·자격증 상태별 색상, 헤더·날짜 경고 |
| **1-3 VLOOKUP 수식** | `apply_formulas.py` | ✅ 구현됨 (파일명: `apply_vlookup_formulas.py`) | 담당소장명·연락처, 자격증명·소유자명·연락처 IFERROR 포함 |

**1단계 결론**: 계획 대비 **완료**. (1단계 전용 완료체크 문서는 없음 → 문서화 보완 권장)

---

### 2단계: 실시간 데이터 연동 API (2-3일)

| 항목 | 계획 | 구현 상태 | 비고 |
|------|------|-----------|------|
| **2-1 데이터 조회** | GET /api/sites, /sites/<id>, /personnel, /certificates, /stats | ✅ 구현됨 | `api/app.py` + routes (sites, personnel, certificates, stats), 필터(company, status, state) |
| **2-2 데이터 수정** | PUT /sites/<id>, POST assign/unassign, POST /sites | ✅ 구현됨 | `Phase2_2-2_완료체크.md` 존재, 검증(validation.py) 포함 |
| **2-3 실시간 동기화** | 낙관적 잠금 + (선택) SSE/WebSocket | ✅ 낙관적 잠금만 구현 | `sync_manager.py`, If-Match/body.version, 409 Conflict. **SSE/WebSocket 미구현** |

**2단계 결론**: **조회·수정·낙관적 잠금까지 완료**. 실시간 푸시(SSE/WebSocket)는 미구현(계획서 3-3에 이관 가능).

---

### 3단계: HTML 앱 개선 (2-3일)

| 항목 | 계획 | 구현 상태 | 비고 |
|------|------|-----------|------|
| **3-1 API 연동** | app.js에서 API 호출로 데이터 로드 | ✅ 구현됨 | `js/api.js`, `js/config.js`, `App.loadAll()` → API.getSites, Dashboard.load → API.getStats |
| **3-2 소장 배정 UI** | 배정 패널, 소장/자격증 선택, 배정 확인 | ✅ 구현됨 | `assignPanel`, `js/assign.js`, Assign.open/confirm, 버전 전달 |
| **3-3 실시간 업데이트** | SSE 또는 WebSocket | ❌ 미구현 | EventSource/WebSocket/stream 엔드포인트 없음 |

**3단계 결론**: **API 연동·소장 배정 UI 완료**. 실시간 푸시(SSE/WebSocket)는 **미구현**.

---

## 2. Red Team 제안 (개발 중 부족한 상황)

Red Team 관점에서 **보안·안정성·운영·UX** 측면의 부족한 점과 개선 제안을 정리했습니다.

---

### 2.1 보안·인증

| 구분 | 현황 | 제안 |
|------|------|------|
| **API 인증** | API 키 검증 미적용 (`verify_api_key` 없음). CORS에 `X-API-Key` 헤더만 허용. | 배포 시 API 키 또는 토큰 검증 도입. 개발/운영 환경 분리(예: `.env`로 `API_KEY` 관리). |
| **민감 정보** | `SPREADSHEET_ID`, 개발용 ID가 코드/문서에 하드코딩된 곳 있음. | `.env`만 사용하고, README/가이드에는 `SPREADSHEET_ID=` 예시만 두고 실제 값은 제거. |
| **CORS** | `ALLOWED_ORIGINS`로 localhost 등 제한 가능하나, 기본값이 넓을 수 있음. | 배포 도메인만 명시하고, 와일드카드 `*` 사용 금지. |

---

### 2.2 오류 처리·복구

| 구분 | 현황 | 제안 |
|------|------|------|
| **409 Conflict** | API는 409 + 메시지 반환. 프론트는 `api.js`에서 토스트만 표시. | 409 시 전용 메시지(예: "다른 사용자가 수정했습니다. 새로고침 후 다시 시도해 주세요.") + [새로고침] 버튼 또는 상세 패널 자동 재조회. |
| **버전 미전달** | 상세를 열지 않고 목록에서만 "배정하기"로 들어가면 `SiteDetail.currentSite`가 없어 version이 비어 있을 수 있음. | 배정 패널을 연 시점에 해당 현장 상세 GET으로 `version` 확보 후 배정/해제 요청에 포함. |
| **네트워크/5xx** | `request()` 실패 시 null 반환 + 토스트. 재시도 없음. | 중요 액션(배정, 수정)은 1회 재시도 또는 "다시 시도" 버튼 제공. |

---

### 2.3 데이터·일관성

| 구분 | 현황 | 제안 |
|------|------|------|
| **Sheets 컬럼 순서** | API/코드가 시트1 22컬럼(예: L,O,T,V) 기준. 시트 구조가 바뀌면 열 매핑 깨짐. | 시트 버전 또는 컬럼명→인덱스 매핑을 한 곳(예: `sheets_service` 또는 config)에서 관리하고, 변경 시 한 번만 수정하도록 정리. |
| **VLOOKUP 컬럼** | `apply_vlookup_formulas.py`가 특정 컬럼 위치(예: 12,13,15,16,17)에 의존. | 시트 레이아웃 변경 시 스크립트와 API column_map을 함께 점검하는 체크리스트를 두는 것 권장. |

---

### 2.4 운영·배포

| 구분 | 현황 | 제안 |
|------|------|------|
| **실시간 반영** | 3-3 SSE/WebSocket 미구현. 사용자가 수동 새로고침 전까지 변경 내용을 못 볼 수 있음. | 단기: `CONFIG.AUTO_REFRESH_INTERVAL`(예: 60초) 활성화로 주기적 재조회. 중기: `/api/stream` SSE 추가 후 전용 클라이언트 구독. |
| **헬스 체크** | `/api/health` 존재. 프론트는 초기 1회만 표시(● 초록/빨강). | 주기적 헬스 체크(예: 30초마다)로 끊김 감지 후 배너/토스트로 "연결이 끊어졌습니다" 안내. |
| **로깅·모니터링** | 서버 예외는 Flask 기본 처리. 구조화된 로그/에러 코드 부족. | 500/404 등에 요청 ID 부여, 로그에 `error_code`, `site_id` 등 남겨 추적 가능하게 하기. |

---

### 2.5 테스트·문서

| 구분 | 현황 | 제안 |
|------|------|------|
| **1단계 완료 문서** | 2-2, 2-3만 완료체크 문서 있음. 1단계는 없음. | `Phase2_1단계_완료체크.md` 추가: 검증/서식/VLOOKUP 실행 방법, 기대 결과, 주의사항. |
| **E2E/통합 테스트** | `test_phase2_step1.py`, `test_phase2_step2.py` 존재. 실제 API 호출·브라우저 E2E는 미확인. | 배정 플로우(현장 선택 → 소장/자격증 선택 → 배정 → 409 시나리오) 자동화 테스트 추가 권장. |
| **API 문서** | `다음단계_개발계획.md`에 예시 있음. 단일 API 레퍼런스(엔드포인트·요청/응답·에러)는 없음. | `docs/API_문서.md` 또는 OpenAPI 스펙으로 정리해 두면 프론트/외부 연동 시 유리. |

---

### 2.6 UX·접근성

| 구분 | 현황 | 제안 |
|------|------|------|
| **로딩 상태** | `UI.showLoading()`/hide 사용. 개별 버튼(배정 확인 등) 비활성화는 assign.js에만 있음. | 배정/해제 요청 중에는 "배정 확인" 버튼 로딩 스피너 또는 "처리 중..." 표시로 중복 클릭 방지. |
| **빈 상태** | "조건에 맞는 현장이 없습니다" 등 메시지 있음. | API 실패(서버 끊김)와 "데이터는 있으나 필터 결과 0건"을 구분해 안내 문구 다르게 표시. |
| **키보드/스크린리더** | 미확인. | 배정 패널 포커스 트랩, 닫기 시 이전 포커스 복귀, 주요 버튼에 aria-label 등 적용 시 접근성 향상. |

---

## 3. 우선순위 제안 (Red Team 기준)

1. **높음**: 409 시 전용 안내 + 새로고침/재조회, 배정 시 버전 확보(상세 GET), API 키/환경 변수 정리.
2. **중간**: 주기적 새로고침 또는 SSE 도입, 헬스 체크 주기화, 1단계 완료체크 문서·API 문서 정리.
3. **낮음**: E2E 테스트, 로깅/모니터링, UX/접근성 세부 개선.

---

## 4. 요약

- **1~3단계**: 1단계(검증/서식/VLOOKUP), 2단계(조회·수정·낙관적 잠금), 3단계(API 연동·소장 배정 UI)는 **목표대로 구현된 상태**입니다.
- **미구현**: 3-3 **실시간 푸시(SSE/WebSocket)**. 단기 대안으로 `AUTO_REFRESH_INTERVAL` 활용 가능.
- **Red Team 관점**에서 가장 먼저 손댈 부분은 **409 처리·버전 확보·API/환경 보안**이고, 이어서 **실시간성·문서·테스트** 보강을 권장합니다.
